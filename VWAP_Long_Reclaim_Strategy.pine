// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © 2026 VWAP Long Reclaim Strategy

//@version=6
strategy(
    title="VWAP Reclaim (LONG-only)",
    shorttitle="VWAP Reclaim LONG",
    overlay=true,
    default_qty_type=strategy.percent_of_equity,
    default_qty_value=3,
    initial_capital=1000,
    pyramiding=1,
    commission_type=strategy.commission.percent,
    commission_value=0.025,
    process_orders_on_close=true,
    calc_on_every_tick=true
)

// Import library
// import wbburgin/wbburgin_utils/2 as utils  // replaced by native slope+bias trend

// ==================== INPUTS ====================

// VWAP Settings
hideonDWM = input(false, title="Hide VWAP on 1D or Above", group="VWAP Settings")
var anchor = input.string(defval="Session", title="Anchor Period",
    options=["Session", "Week", "Month", "Quarter", "Year", "Decade", "Century", "Earnings", "Dividends", "Splits"], 
    group="VWAP Settings")
src = input(title="Source", defval=hlc3, group="VWAP Settings")
offset = input(0, title="Offset", group="VWAP Settings")

// Standard Deviation Bands Settings
showBand_1 = input(true, title="Show Band 1", group="Standard Deviation Bands Settings")
stdevMult_1 = input(0.88, title="Standard Deviation Multiplier", group="Standard Deviation Bands Settings")

// Strategy Settings
simpleVwapCross = input.bool(false, "Simple VWAP Cross Entry",
    tooltip="BUY sobald der Preis den VWAP von unten kreuzt. Überspringt die Reclaim→Retest→Go Sequenz.",
    group="Strategy")
breakoutEntry = input.bool(true, "Breakout Entry (Pullback High)",
    tooltip="BUY wenn Close den rollenden Pullback High bricht (Reclaim→Retest→Go). Kann unabhängig vom Simple VWAP Cross ein-/ausgeschaltet werden.",
    group="Strategy")
matchedTrends = input.bool(true, "Only Enter on Matched Trends",
    tooltip="Only enter a long trade when the VWAP is trending up.",
    group="Strategy")

displaybars = input.bool(true, "Barcolors", group="Display")
showTradeLabels = input.bool(true, "Show Trade Labels", group="Display")

// Trend Detection Settings
trendSlopeBars = input.int(5, "VWAP Slope Lookback", minval=1, maxval=20,
    tooltip="Bars for VWAP slope calculation. Lower = faster but noisier.",
    group="Trend Detection")
trendEmaLen = input.int(8, "Price Bias EMA Length", minval=3, maxval=50,
    tooltip="EMA length for price-above-VWAP bias. Lower = earlier signal.",
    group="Trend Detection")

// Reclaim Settings
preset3m = input.string("Neutral", "3m Preset", options=["Aggressive", "Neutral", "Conservative", "Custom"], group="Reclaim Settings")
reclaimWindowBars = input.int(12, "Reclaim: Max Bars bis Retest", minval=1, group="Reclaim Settings")
retestTolATR = input.float(0.10, "Retest Toleranz (ATR-Anteil)", minval=0.0, step=0.01, group="Reclaim Settings")
useAtrTol = input.bool(true, "Toleranz via ATR", group="Reclaim Settings")
debug = input.bool(true, "Debug Markers", group="Reclaim Settings")
showStatusTable = input.bool(true, "Show Status Table", group="Reclaim Settings")
pullbackLookback = input.int(5, "Pullback High Lookback", minval=2, maxval=30,
    tooltip="Rolling-Fenster für den Pullback High (Donchian). Kleiner = schneller. Default 5.",
    group="Reclaim Settings")

reclaimWindowBarsEff = preset3m == "Aggressive" ? 20 : preset3m == "Conservative" ? 8 : preset3m == "Neutral" ? 12 : reclaimWindowBars
retestTolATREff = preset3m == "Aggressive" ? 0.16 : preset3m == "Conservative" ? 0.06 : preset3m == "Neutral" ? 0.10 : retestTolATR

cumVolume = ta.cum(volume)
if barstate.islast and cumVolume == 0
    runtime.error("No volume is provided by the data vendor.")

// ==================== DATA REQUESTS ====================

new_earnings = request.earnings(syminfo.tickerid, earnings.actual, barmerge.gaps_on, barmerge.lookahead_on, ignore_invalid_symbol=true)
new_dividends = request.dividends(syminfo.tickerid, dividends.gross, barmerge.gaps_on, barmerge.lookahead_on, ignore_invalid_symbol=true)
new_split = request.splits(syminfo.tickerid, splits.denominator, barmerge.gaps_on, barmerge.lookahead_on, ignore_invalid_symbol=true)

// ==================== VWAP ANCHOR PERIOD ====================

isNewPeriod = switch anchor
    "Earnings"  => not na(new_earnings)
    "Dividends" => not na(new_dividends)
    "Splits"    => not na(new_split)
    "Session"   => timeframe.change("D")
    "Week"      => timeframe.change("W")
    "Month"     => timeframe.change("M")
    "Quarter"   => timeframe.change("3M")
    "Year"      => timeframe.change("12M")
    "Decade"    => timeframe.change("12M") and year % 10 == 0
    "Century"   => timeframe.change("12M") and year % 100 == 0
    => false

isEsdAnchor = anchor == "Earnings" or anchor == "Dividends" or anchor == "Splits"
if na(src[1]) and not isEsdAnchor
    isNewPeriod := true

// ==================== VWAP CALCULATION ====================

var float vwapValue = na
var float upperBandValue1 = na
var float lowerBandValue1 = na
var float upperBandValue2 = na
var float lowerBandValue2 = na

if not (hideonDWM and timeframe.isdwm)
    [_vwap, _stdevUpper, _] = ta.vwap(src, isNewPeriod, 1)
    vwapValue := _vwap
    stdevAbs = _stdevUpper - _vwap
    upperBandValue1 := _vwap + stdevAbs * stdevMult_1
    lowerBandValue1 := _vwap - stdevAbs * stdevMult_1
    upperBandValue2 := _vwap + 2 * stdevAbs * stdevMult_1
    lowerBandValue2 := _vwap - 2 * stdevAbs * stdevMult_1

// ==================== RECLAIM -> RETEST -> GO (LONG-ONLY) ====================

atr = ta.atr(14)
tol = useAtrTol ? atr * retestTolATREff : syminfo.mintick * 2

wasBelowVwap = close[1] < vwapValue[1]
reclaimUp = wasBelowVwap and close > vwapValue

var int reclaimBar = na
var float retestLow = na
var bool inReclaimSeq = false
var bool retestSeen = false

// Rolling highest high (Donchian) — replaces monotonic pullbackHigh.
pullbackHigh = ta.highest(high, pullbackLookback)

if reclaimUp
    reclaimBar := bar_index
    inReclaimSeq := true
    retestSeen := false
    retestLow := na

if inReclaimSeq
    expired = (bar_index - reclaimBar) > reclaimWindowBarsEff
    hardFail = close < vwapValue - tol
    if expired or hardFail
        inReclaimSeq := false
        retestSeen := false

    if not retestSeen
        retestCond = low <= vwapValue + tol and close >= vwapValue - tol
        if retestCond
            retestSeen := true
            retestLow := low

goLong = inReclaimSeq and retestSeen and close > pullbackHigh[1] and bar_index > reclaimBar

vwapSlope = ta.change(vwapValue, trendSlopeBars)
priceBias = ta.ema(close, trendEmaLen) > vwapValue
isUpTrend = vwapSlope > 0 or priceBias
matchedTrendsFilter_long = not matchedTrends ? true : isUpTrend

// Entry signal: simpleVwapCross has priority — when on, only VWAP
// cross entries fire (no breakout). When off, breakoutEntry toggle
// controls the Reclaim→Retest→Go breakout.
entryTrigger = simpleVwapCross ? reclaimUp : (breakoutEntry and goLong)
longSignal = entryTrigger and matchedTrendsFilter_long and strategy.position_size == 0

// ==================== STRATEGY LOGIC ====================

var float longStop = na

if longSignal
    strategy.entry("Long", strategy.long)
    // Simple cross: no retestLow available → use VWAP minus tolerance as stop
    longStop := simpleVwapCross ? vwapValue - tol : retestLow - tol
    inReclaimSeq := false
    retestSeen := false

if strategy.position_size > 0 and not na(longStop)
    strategy.exit("L-Stop", "Long", stop=longStop)

exitOnVwapLoss = strategy.position_size > 0 and close < vwapValue - tol
if exitOnVwapLoss
    strategy.close("Long")

// ==================== PLOTS ====================

plot(vwapValue, title="VWAP", color=color.white, linewidth=2, offset=offset)

upperBand_1 = plot(showBand_1 ? upperBandValue1 : na, title="Upper Band #1", color=color.new(color.gray, 50), offset=offset, linewidth=1)
lowerBand_1 = plot(showBand_1 ? lowerBandValue1 : na, title="Lower Band #1", color=color.new(color.gray, 50), offset=offset, linewidth=1)

plot(upperBandValue2, title="Upper Band #2", color=color.lime, linewidth=1)
plot(lowerBandValue2, title="Lower Band #2", color=color.red, linewidth=1)

hl2_plot = plot(hl2, color=na, title="HL2")

// ==================== FILLS ====================

fill(hl2_plot, upperBand_1, color=hl2 > upperBandValue1 ? color.new(color.green, 50) : na, title="Above Upper Band")
fill(hl2_plot, lowerBand_1, color=hl2 < lowerBandValue1 ? color.new(color.red, 50) : na, title="Below Lower Band")
fill(upperBand_1, lowerBand_1, title="Bands Fill", color=isUpTrend ? color.new(color.lime, 88) : color.new(color.red, 88))

// ==================== BAR COLORING ====================

barcolor(displaybars ? (isUpTrend ? color.new(color.lime, 30) : color.new(color.red, 30)) : na, title="Trade Direction")

// ==================== ENTRY/EXIT MARKERS ====================

plotshape(debug and reclaimUp, title="ReclaimUp", style=shape.triangleup, location=location.belowbar, color=color.new(color.white, 0), size=size.tiny, text="R")
plotshape(debug and retestSeen and inReclaimSeq, title="RetestSeen", style=shape.circle, location=location.belowbar, color=color.new(color.yellow, 0), size=size.tiny, text="T")
plotshape(showTradeLabels and longSignal, title="Long Entry", style=shape.labelup, location=location.belowbar, color=color.new(color.lime, 0), textcolor=color.white, size=size.tiny, text="Buy")
plotshape(showTradeLabels and exitOnVwapLoss, title="VWAP Loss Exit", style=shape.labeldown, location=location.abovebar, color=color.new(color.orange, 0), textcolor=color.white, size=size.tiny, text="Exit")
plot(inReclaimSeq or strategy.position_size > 0 ? pullbackHigh : na, title="Pullback High", color=color.new(color.aqua, 0), linewidth=1)

// ==================== STATUS TABLE ====================

var table statusTable = table.new(position.top_right, 2, 7, border_width=1)
if barstate.islast
    if showStatusTable
        table.cell(statusTable, 0, 0, "Preset", text_color=color.white, bgcolor=color.new(color.blue, 65))
        table.cell(statusTable, 1, 0, preset3m, text_color=color.white, bgcolor=color.new(color.blue, 80))

        table.cell(statusTable, 0, 1, "Window", text_color=color.white, bgcolor=color.new(color.gray, 70))
        table.cell(statusTable, 1, 1, str.tostring(reclaimWindowBarsEff), text_color=color.white, bgcolor=color.new(color.gray, 85))

        table.cell(statusTable, 0, 2, "Tol ATR", text_color=color.white, bgcolor=color.new(color.gray, 70))
        table.cell(statusTable, 1, 2, str.tostring(retestTolATREff, "#.##"), text_color=color.white, bgcolor=color.new(color.gray, 85))

        table.cell(statusTable, 0, 3, "Tol Mode", text_color=color.white, bgcolor=color.new(color.gray, 70))
        table.cell(statusTable, 1, 3, useAtrTol ? "ATR" : "Ticks", text_color=color.white, bgcolor=color.new(color.gray, 85))

        table.cell(statusTable, 0, 4, "Tol Px", text_color=color.white, bgcolor=color.new(color.gray, 70))
        table.cell(statusTable, 1, 4, str.tostring(tol, format.mintick), text_color=color.white, bgcolor=color.new(color.gray, 85))

        table.cell(statusTable, 0, 5, "Anchor", text_color=color.white, bgcolor=color.new(color.gray, 70))
        table.cell(statusTable, 1, 5, anchor, text_color=color.white, bgcolor=color.new(color.gray, 85))

        anchorHint = anchor == "Session" ? "OK" : "3m daytrade: Session"
        anchorBg = anchor == "Session" ? color.new(color.green, 75) : color.new(color.orange, 65)
        table.cell(statusTable, 0, 6, "Hint", text_color=color.white, bgcolor=color.new(color.gray, 70))
        table.cell(statusTable, 1, 6, anchorHint, text_color=color.white, bgcolor=anchorBg)
    else
        table.clear(statusTable, 0, 0, 1, 6)
